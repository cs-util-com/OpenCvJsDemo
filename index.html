<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Minimal OpenCV.js WASM (CDN)</title>
    <style>
        body { font-family: sans-serif; padding: 1em; }
        #status { margin-bottom: 1em; font-weight: bold; color: #555; }
        #canvasOutput { border: 1px solid black; }
        .ready { color: green; }
        .error { color: red; }
    </style>
</head>

<body>
    <h1>Minimal OpenCV.js WASM Example (Using Hosted Files)</h1>
    <div id="status">Initializing OpenCV.js from docs.opencv.org... Please Wait.</div>
    <p>A blue rectangle should appear below if OpenCV.js loaded and executed correctly from the remote URL.</p>
    <canvas id="canvasOutput" width="320" height="240"></canvas>

    <script>
        // --- 1. OpenCV WASM Module Configuration ---
        // Define the Module object *before* loading opencv.js
        var Module = {
            // **IMPORTANT**: Use the ABSOLUTE URL to the hosted WASM file
            wasmBinaryFile: 'https://docs.opencv.org/4.9.0/opencv_js.wasm',
            // Use onRuntimeInitialized - standard Emscripten callback
            onRuntimeInitialized: function() { onOpenCvReady(); }
        };

        // --- 2. OpenCV Ready Callback ---
        // Function to run when the WASM module is loaded and ready
        async function onOpenCvReady() {
            const statusElement = document.getElementById('status');
            console.log('OpenCV runtime initialized from remote source.');

            // Ensure cv is ready, potentially handling Promises
            try {
                 if (typeof cv === 'undefined') {
                    statusElement.textContent = 'Error: cv object is undefined after loading from remote source.';
                    statusElement.className = 'error';
                    console.error('Error: cv object is undefined.');
                    return;
                 }
                 cv = (cv instanceof Promise) ? await cv : cv;
                 console.log('cv object is ready:', cv);

                 statusElement.textContent = 'OpenCV.js is ready (loaded from CDN).';
                 statusElement.classList.add('ready');

            } catch (error) {
                statusElement.textContent = 'Error resolving cv object. Check console.';
                statusElement.className = 'error';
                console.error("Error resolving cv object: ", error);
                return; // Stop execution if cv isn't ready
            }

            // --- 3. Simple OpenCV Operation ---
            try {
                // Use getBuildInformation() instead of getVersionString()
                console.log("OpenCV Build Information:", cv.getBuildInformation());

                let canvas = document.getElementById('canvasOutput');

                // Create an OpenCV Mat - USE CV_8UC4 as a CONSTANT
                let mat = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4); // REMOVED ()

                // Define points and color (Blue this time)
                let point1 = new cv.Point(75, 75);
                let point2 = new cv.Point(245, 165);
                let color = new cv.Scalar(0, 0, 255, 255); // Blue (RGBA)
                let thickness = -1; // Fill the rectangle

                // Draw rectangle on the Mat
                cv.rectangle(mat, point1, point2, color, thickness);

                // Display the Mat on the canvas
                cv.imshow('canvasOutput', mat);

                // --- 4. Clean up OpenCV objects ---
                mat.delete(); // Don't forget cleanup!

                console.log('Successfully drew rectangle using remotely loaded OpenCV.');
                statusElement.textContent = 'OpenCV.js ready (CDN). Rectangle drawn!';

            } catch (error) {
                 statusElement.textContent = 'Error executing OpenCV code. Check console.';
                 statusElement.className = 'error';
                 console.error("Error executing OpenCV code: ", error); // This will catch further errors
            }
        }

        // --- 5. Script Loading Error Handler ---
        function onOpenCvScriptError(event) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = 'Error loading opencv.js script from remote URL. Check network tab and CDN status.';
            statusElement.className = 'error';
            console.error("Error loading remote opencv.js script: ", event);
        }

    </script>

    <!-- 6. Load OpenCV.js Asynchronously from the official docs URL -->
    <!-- **IMPORTANT**: Use the ABSOLUTE URL to the hosted JS file -->
    <script async src="https://docs.opencv.org/4.9.0/opencv.js"
            onerror="onOpenCvScriptError(event)"></script>

</body>
</html>